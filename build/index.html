<!DOCTYPE html>
<html>
    <head>
            <meta charset="utf-8">
            <title>iotiscool-c</title>
            <!--<script src="main.js"></script>-->
            <script src="rockiot.server.js"></script>
    </head>
    <body>
        <a href="javascript:void(0)" class="hide" onclick="subscribeDevice()">Start</a>
        <a href="javascript:void(0)" class="hide" onclick="unsubscribeDevice()">Stop</a>
        <h3 id="payload"></h3>
        <div id="response" class="bar"></div>
        <p>
            <a href="#" onclick="authenticate()">Login</a>

        </p>
    </body>
    <style>
        body {
            font-family: monospace;
            font-size:1.3rem;
        }
        h3 { font-size: 5rem; color: crimson; }
        a { background:#cecece; border-radius:5px; border:1px solid #888; padding-top:2px; padding-bottom:2px ; padding-right:4px; padding-left:4px;text-decoration:none;outline:none; font-size:1.1rem; }
        a:hover {
            background: #333; color:white;
        }
        .bar {
            height:1rem;
            border-top-right-radius:4px;
            border-bottom-right-radius:4px;
        }

    </style>
  <script>
    const client = rockiot.client({
      url: 'https://iotiscool-api.herokuapp.com'
    })
    console.log ( client )
    client.api.service('assets/devices').find().then ( res => {
        devices = res.data;
        console.log ( devices )
        id = devices[0]._id;
    }).catch( error => {
        console.log ( error )
    })
    /*
    const api = iotiscool;
    //create app
    const app = new api.server();
    //set socket for server url
    const socket = api.io('https://iotiscool-api.herokuapp.com',{
        transports: ['websocket'],
    });
    //open socket
    app.configure(api.socketio(socket));
    //set auth JWT to localStorage
    app.configure(api.auth({ storage: window.localStorage }));

    //just a test topic/payload
    const test = {
        "topic" : "iotiscool/home/outside",
        "url": "http://test.mosquitto.org",
        "port": "1883",
        "name": "Garden Temperature",
        "payload" : "33"
    }

    const topic = "parmenides/kitchen/outside"
    var devices = [];
    var id;
    function getDevices(){
        app.service('assets/devices').find().then ( res => {
            devices = res.data;
            console.log ( devices )
            id = devices[0]._id;
        }).catch( error => {
            console.log ( error )
        })
    }

    function subscribeDevice(){
        if ( id ){
            app.service('gateway/devices/' + id + '/subscribe').find().then ( resp => {
                console.log ( resp )
            }).catch ( error => {
                console.log ( error )
            })
        }
    }


    function unsubscribeDevice(){
        if ( id ){
            app.service('gateway/devices/' + id + '/unsubscribe').find().then ( resp => {
                console.log ( resp )
            }).catch ( error => {
                console.log ( error )
            })
        }
    }

    function test_publish(){
        console.log ( 'publishing ...')
        const test = {
        "topic" : "iotiscool/outside",
	    "url": "http://test.mosquitto.org",
	    "port": "1883",
        "name": "Garden Temperature",
        "payload" : randomize().toString()
        }
        app.service('gateway/direct/publish').create(test).then ( res =>{
            console.log ( res )
        }).catch ( err => {
            document.getElementById('response').innerText = JSON.stringify(err);
        })
    }

    app.service('gateway/realtime').on('payload',function(payload){
        console.log ( payload )
        if ( payload.topic === topic ){
            document.getElementById('payload').innerText = payload.msg;
            //document.getElementById('response').style = 'background:red;width:' + payload.msg + "rem;";
        }
    })

    app.authenticate().then(resp=> {
        console.log ( resp ) ;
        getDevices();
    }).catch ( error => {
        authenticate();
    })

    function authenticate(){
        app.authenticate({
            email: 'admin',
            password: 'password',
            strategy: 'local'
        }).then (  user => {
            console.log ( user );
            getDevices();
        }).catch ( error => {
            console.log ( error );
        })
    }
    var repeater
    function simulator(){
        repeater = setInterval(() => test_publish(), 2000);
    }
    function stopSimulator(){
        clearInterval(repeater);
        app.service('gateway/direct/unsubscribe').create(test).then( resp => {
            document.getElementById('response').innerText = JSON.stringify(res);
        }).catch ( err => {
            document.getElementById('response').innerText = JSON.stringify(err);
        })
    }
    function randomize(minimum=0,maximum=100){
        return Math.floor(Math.random() * (maximum - minimum + 1)) + minimum;
    }
    */
    </script>
</html>
