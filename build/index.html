<!DOCTYPE html>
<html>
    <head>
            <meta charset="utf-8">
            <title>iotiscool-c</title>
            <!--<script src="main.js"></script>-->
            <script src="rockiot.server.js"></script>
    </head>
    <body>
        <a href="javascript:void(0)" class="hide" onclick="subscribeDevice()">Start</a>
        <a href="javascript:void(0)" class="hide" onclick="unsubscribeDevice()">Stop</a>
        <h3 id="payload"></h3>
        <div id="response" class="bar">
          <div class="progress"></div>
        </div>
        <p>
            <a href="#" onclick="authenticate()">Login</a>

        </p>
    </body>
    <style>
        body {
            font-family: monospace;
            font-size:1.3rem;
        }
        h3 { font-size: 5rem; color: crimson; }
        a { background:#cecece; border-radius:5px; border:1px solid #888; padding-top:2px; padding-bottom:2px ; padding-right:4px; padding-left:4px;text-decoration:none;outline:none; font-size:1.1rem; }
        a:hover {
            background: #333; color:white;
        }
        .bar {
            height:1rem;
            border-radius:4px;
            border:1px solid black;
            width:100%;
        }
        .progress {
          width:0%;
          border-radius:4px;
          height:100%;
        }

    </style>
  <script>
    //create rockiot client (websocket)
    //@url : rockiot-api URL
    //@login: rockiot-api login info { user: username , password: password , strategy: strategy }
    //@storage: rockiot-api JWT storage location (default localStorage)
    //@timeout: rockiot-api timeout (ms)
    const client = rockiot.client({
      url: 'http://localhost:3030',
      login: {
        user: 'admin',
        password: 'password',
        strategy: 'local'
      },
      storage: window.localStorage,
      timeout: 5000
    })

    function subscribeDevice(){
      //rockiot.topic ( action , topic)
      //@action: subscribe/unsubscribe
      //@topic : { url: mqtt broker url , port: mqtt broker port , topic: mqtt topic, name: device name}
      rockiot.topic('subscribe', {
        url: 'http://test.mosquitto.org',
        port: '1883',
        topic: 'rockiot/garden/outside',
        name: 'Home Garden'
      }).then(resp=>{
        console.log ( resp )
      })
    }


    function unsubscribeDevice(){
      rockiot.topic('unsubscribe', {
        url: 'http://test.mosquitto.org',
        port: '1883',
        topic: 'rockiot/garden/outside',
        name: 'Home Garden'
      }).then(resp=>{
        console.log ( resp )
      })
    }

    //client.api.service('mqtt/realtime').on('payload')
    //get realtime data from subscribed topics
    //return the following payload
    //  {
    //    msg: value,
    //    date: dateTime,
    //    topic: mqtt broker topic,
    //    device: device name,
    //    user: rockiot-api user id (authenticated)
    //  }
    client.api.service('mqtt/realtime').on('payload', (payload) => {
      document.getElementById('payload').innerText = parseFloat(payload.msg).toFixed(2);
      document.querySelector('.progress').style = 'background:#ff000070;width:' + payload.msg + "%;";
      console.log ( 'payload=>' , payload )
    })
    
    </script>
</html>
